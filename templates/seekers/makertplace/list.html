{% extends "seekers/seekers_base.html" %}
{% load static humanize %}
{% load price_format %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Search and Filter Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Find Your Perfect Home</h1>
        <p class="text-gray-600 mb-6">Browse {{ properties.paginator.count|intcomma }} properties listed by verified landlords</p>
        
        <!-- Improved Search and Filter Bar -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
            <form method="GET" action="{% url 'seekers:marketplace' %}" id="search-form">
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input id="search-input" type="text" name="q" value="{{ request.GET.q }}" 
                                   placeholder="Location, property name or features..." 
                                   class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 w-full md:w-auto">
                        <button type="button" id="filter-toggle" class="flex items-center justify-center px-5 py-3 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition w-full md:w-auto">
                            <i class="fas fa-sliders-h text-gray-600 mr-2"></i> Filters
                        </button>
                        <button type="submit" class="px-5 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center justify-center w-full md:w-auto">
                            <i class="fas fa-search mr-2"></i> Search
                        </button>
                    </div>
                </div>
                
                <!-- Expanded Filters (hidden by default) -->
                <div id="filter-panel" class="hidden mt-6 pt-6 border-t border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
                            <select name="property_type" class="block w-full pl-3 pr-8 py-2.5 text-base border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <option value="">All Types</option>
                                {% for value, label in property_types %}
                                <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
                            <select name="price_range" class="block w-full pl-3 pr-8 py-2.5 text-base border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Any Price</option>
                                <option value="0-100000" {% if request.GET.price_range == "0-100000" %}selected{% endif %}>Under ₦100,000</option>
                                <option value="100000-250000" {% if request.GET.price_range == "100000-250000" %}selected{% endif %}>₦100,000 - ₦250,000</option>
                                <option value="250000-500000" {% if request.GET.price_range == "250000-500000" %}selected{% endif %}>₦250,000 - ₦500,000</option>
                                <option value="500000-1000000" {% if request.GET.price_range == "500000-1000000" %}selected{% endif %}>₦500,000 - ₦1M</option>
                                <option value="1000000" {% if request.GET.price_range == "1000000" %}selected{% endif %}>Over ₦1M</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                            <select name="bedrooms" class="block w-full pl-3 pr-8 py-2.5 text-base border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Any</option>
                                <option value="1" {% if request.GET.bedrooms == "1" %}selected{% endif %}>1+</option>
                                <option value="2" {% if request.GET.bedrooms == "2" %}selected{% endif %}>2+</option>
                                <option value="3" {% if request.GET.bedrooms == "3" %}selected{% endif %}>3+</option>
                                <option value="4" {% if request.GET.bedrooms == "4" %}selected{% endif %}>4+</option>
                                <option value="5" {% if request.GET.bedrooms == "5" %}selected{% endif %}>5+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                            <select name="sort" class="block w-full pl-3 pr-8 py-2.5 text-base border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <option value="newest" {% if request.GET.sort == "newest" %}selected{% endif %}>Newest Listings</option>
                                <option value="price-low" {% if request.GET.sort == "price-low" %}selected{% endif %}>Price: Low to High</option>
                                <option value="price-high" {% if request.GET.sort == "price-high" %}selected{% endif %}>Price: High to Low</option>
                                <option value="popular" {% if request.GET.sort == "popular" %}selected{% endif %}>Most Popular</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            {% if filtered %}
                            <span>{{ properties.paginator.count }} results match your filters</span>
                            {% endif %}
                        </div>
                        <div class="flex gap-3">
                            <button type="button" id="reset-filters" class="px-5 py-2.5 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition flex items-center">
                                <i class="fas fa-undo mr-2"></i> Reset
                            </button>
                            <button type="submit" class="px-5 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center">
                                <i class="fas fa-check mr-2"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Property Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for property in properties %}
        <div class="property-card bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100">
            <div class="relative">
                <a href="{% url 'seekers:property_detail_pk' property.pk %}">
                    {% if property.primary_image %}
                    <img src="{{ property.primary_image.image.url }}" 
                        alt="{{ property.name }}" 
                        class="w-full h-72 object-cover transition-transform duration-500 hover:scale-105">
                    {% else %}
                    <img src="https://images.unsplash.com/photo-1580587771525-78b9dba3b914?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80" 
                        alt="Property image" 
                        class="w-full h-72 object-cover transition-transform duration-500 hover:scale-105">
                    {% endif %}
                </a>
                <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                    <button class="quick-view-btn bg-white text-primary-800 px-4 py-2 rounded-full flex items-center ml-auto" data-property-id="{{ property.id }}">
                        <i class="fas fa-expand mr-2"></i> Quick View
                    </button>
                </div>
                <div class="absolute top-4 left-4 flex flex-col gap-2">
                    {% if property.is_verified %}
                    <span class="verified-badge bg-primary-600 text-white px-3 py-1 rounded-full text-xs flex items-center">
                        <i class="fas fa-check-circle mr-1"></i> Verified
                    </span>
                    {% endif %}
                    {% if property.is_featured %}
                    <span class="featured-badge bg-white text-primary-800 px-3 py-1 rounded-full text-xs flex items-center shadow-sm">
                        <i class="fas fa-star mr-1 text-yellow-400"></i> Featured
                    </span>
                    {% endif %}
                </div>
                <div class="absolute bottom-4 right-4 bg-white/90 text-primary-800 px-3 py-1 rounded-full text-xs flex items-center shadow-sm">
                    <i class="fas fa-eye mr-1"></i> {{ property.views|default:"0" }} views
                </div>
            </div>
            <div class="p-5">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-xl font-bold text-primary-800">
                        <a href="{% url 'seekers:property_detail_pk' property.pk %}" class="hover:text-primary-600 transition">
                            <i class="fas fa-home text-primary-600 mr-2"></i>{{ property.name }}
                        </a>
                    </h3>
                    <button class="save-btn text-gray-400 hover:text-primary-600 transition" data-property-id="{{ property.id }}">
                        <i class="{% if property.id in saved_property_ids %}fas text-red-500{% else %}far{% endif %} fa-heart text-xl"></i>
                    </button>
                </div>
                <div class="flex items-center text-gray-600 mb-4">
                    <i class="fas fa-map-marker-alt text-primary-400 mr-2"></i>
                    <span>{{ property.address|truncatechars:30 }}</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-4">
                    {% if property.bedrooms %}
                    <span class="amenity-chip bg-primary-50 text-primary-800 px-3 py-1 rounded-full text-xs">
                        <i class="fas fa-bed mr-1"></i>{{ property.bedrooms }} Beds
                    </span>
                    {% endif %}
                    {% if property.bathrooms %}
                    <span class="amenity-chip bg-primary-50 text-primary-800 px-3 py-1 rounded-full text-xs">
                        <i class="fas fa-bath mr-1"></i>{{ property.bathrooms }} Baths
                    </span>
                    {% endif %}
                    {% for amenity in property.amenities.all|slice:":2" %}
                    <span class="amenity-chip bg-primary-50 text-primary-800 px-3 py-1 rounded-full text-xs">
                        <i class="{{ amenity.icon|default:'fas fa-check' }} mr-1"></i>{{ amenity.name }}
                    </span>
                    {% endfor %}
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-4">
                    <div>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calendar-alt mr-1"></i>{{ property.get_price_period_display }}
                        </p>
                        <p class="text-xl font-bold text-primary-800">{{ property.price|short_price }}</p>
                    </div>
                    <div class="flex gap-2">
                        <a href="{% url 'seekers:property_message' property.id %}" 
                        class="message-btn bg-primary-100 text-primary-800 p-2 rounded-full hover:bg-primary-200 transition">
                            <i class="fas fa-comment-dots"></i>
                        </a>
                        <a href="{% url 'seekers:property_detail_pk' property.pk %}" 
                        class="cta-btn bg-primary-800 text-white px-4 py-2 rounded-full hover:bg-primary-700 transition">
                            <i class="fas fa-external-link-alt mr-1"></i> View
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <!-- Empty State (maintaining the same UI style) -->
        <div class="col-span-full bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 p-12 text-center">
            <div class="mx-auto max-w-md">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-primary-50 mb-4">
                    <i class="fas fa-home text-2xl text-primary-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">No properties found</h3>
                <p class="mt-2 text-sm text-gray-500">Try adjusting your search or filters to find what you're looking for.</p>
                <div class="mt-6">
                    <button id="reset-all-filters" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 border border-transparent rounded-full text-sm font-medium text-white shadow-sm transition">
                        Reset All Filters
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

<!-- Enhanced Pagination - More Visible Version -->
{% with True as properties.has_other_pages %}
  <div class="mt-12 flex flex-col sm:flex-row items-center justify-between border-t border-gray-200 pt-8">
    <div class="mb-4 sm:mb-0">
        <p class="text-sm text-gray-700">
            Showing <span class="font-medium">{{ properties.start_index }}</span> to 
            <span class="font-medium">{{ properties.end_index }}</span> of 
            <span class="font-medium">{{ properties.paginator.count|intcomma }}</span> results
        </p>
    </div>
    <nav class="flex items-center gap-2">
        {% if properties.has_previous %}
            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page=1" 
               class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-primary-600 hover:text-white transition flex items-center bg-white text-gray-700" 
               title="First">
                <i class="fas fa-angle-double-left"></i>
                <span class="ml-1 hidden sm:inline">First</span>
            </a>
            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ properties.previous_page_number }}" 
               class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-primary-600 hover:text-white transition flex items-center bg-white text-gray-700" 
               title="Previous">
                <i class="fas fa-angle-left"></i>
                <span class="ml-1 hidden sm:inline">Prev</span>
            </a>
        {% else %}
            <span class="px-4 py-2 rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed flex items-center bg-gray-100">
                <i class="fas fa-angle-double-left"></i>
                <span class="ml-1 hidden sm:inline">First</span>
            </span>
            <span class="px-4 py-2 rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed flex items-center bg-gray-100">
                <i class="fas fa-angle-left"></i>
                <span class="ml-1 hidden sm:inline">Prev</span>
            </span>
        {% endif %}

        <div class="flex items-center gap-1 mx-2">
            {% for num in properties.paginator.page_range %}
                {% if properties.number == num %}
                    <span class="px-4 py-2 rounded-lg bg-primary-600 text-white font-medium border border-primary-600">
                        {{ num }}
                    </span>
                {% elif num > properties.number|add:'-3' and num < properties.number|add:'3' %}
                    <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" 
                       class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-primary-100 transition bg-white text-gray-700">
                        {{ num }}
                    </a>
                {% elif num == properties.number|add:'-3' or num == properties.number|add:'3' %}
                    <span class="px-2 py-2 text-gray-500">...</span>
                {% endif %}
            {% endfor %}
        </div>

        {% if properties.has_next %}
            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ properties.next_page_number }}" 
               class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-primary-600 hover:text-white transition flex items-center bg-white text-gray-700" 
               title="Next">
                <span class="mr-1 hidden sm:inline">Next</span>
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ properties.paginator.num_pages }}" 
               class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-primary-600 hover:text-white transition flex items-center bg-white text-gray-700" 
               title="Last">
                <span class="mr-1 hidden sm:inline">Last</span>
                <i class="fas fa-angle-double-right"></i>
            </a>
        {% else %}
            <span class="px-4 py-2 rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed flex items-center bg-gray-100">
                <span class="mr-1 hidden sm:inline">Next</span>
                <i class="fas fa-angle-right"></i>
            </span>
            <span class="px-4 py-2 rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed flex items-center bg-gray-100">
                <span class="mr-1 hidden sm:inline">Last</span>
                <i class="fas fa-angle-double-right"></i>
            </span>
        {% endif %}
    </nav>
</div>
{% endwith %}
</div>

<style>
    /* Pagination hover effects */
    .pagination a:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Current page highlight */
    .pagination .current {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    /* Disabled buttons */
    .pagination .disabled {
        opacity: 0.6;
    }
    .property-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .property-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .quick-view-btn {
        transition: all 0.3s ease;
    }
    .quick-view-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .amenity-chip {
        transition: all 0.2s ease;
    }
    .amenity-chip:hover {
        transform: translateY(-1px);
        background-color: #e0f2fe;
    }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .save-btn:hover i {
        transform: scale(1.1);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle filter panel
    const filterToggle = document.getElementById('filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    
    if (filterToggle && filterPanel) {
        filterToggle.addEventListener('click', function() {
            filterPanel.classList.toggle('hidden');
            this.classList.toggle('bg-gray-100');
            this.querySelector('i').classList.toggle('text-primary-600');
        });
    }
    
    // Reset filters
    const resetFilters = document.getElementById('reset-filters');
    const resetAllFilters = document.getElementById('reset-all-filters');
    
    if (resetFilters) {
        resetFilters.addEventListener('click', function() {
            document.getElementById('search-form').reset();
        });
    }
    
    if (resetAllFilters) {
        resetAllFilters.addEventListener('click', function() {
            window.location.href = "{% url 'seekers:marketplace' %}";
        });
    }
    
    // Save property functionality
    const saveButtons = document.querySelectorAll('.save-btn');
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const propertyId = this.getAttribute('data-property-id');
            const icon = this.querySelector('i');
            const isSaved = icon.classList.contains('fas');
            
            fetch(`/api/properties/${propertyId}/toggle_save/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isSaved) {
                        icon.classList.remove('fas', 'text-red-500');
                        icon.classList.add('far');
                    } else {
                        icon.classList.remove('far');
                        icon.classList.add('fas', 'text-red-500');
                    }
                    // Add animation
                    icon.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 300);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
    
    // Quick view functionality
    const quickViewButtons = document.querySelectorAll('.quick-view-btn');
    quickViewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const propertyId = this.getAttribute('data-property-id');
            
            // Show loading state
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
            this.disabled = true;
            
            fetch(`/api/properties/${propertyId}/quick_view/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Restore button state
                this.innerHTML = originalContent;
                this.disabled = false;
                
                // Implement your modal display logic here
                console.log('Quick view data:', data);
                // Example: showModal(data);
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = originalContent;
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}